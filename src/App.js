import React, {Component} from 'react';
import {BrowserRouter as Router, Route, Switch} from 'react-router-dom';
import SearchPage from "./Components/SearchPage";
import Exploit from "./Components/Exploit";
import NewExploit from "./Components/NewExploit";
import Shodan from "./Components/Shodan";
import Account from "./Components/Account";
import Login from "./Components/Login";
import CreateUser from "./Components/CreateUser";
import Admin from "./Components/Admin";

class App extends Component {
  constructor(props) {
    super(props);
    this.state = {
      user: null,
      loaded: false,
      homepage: 'http://localhost:3001/api',
      startPage: 'http://localhost:3000'
    }
  }
  
  componentDidMount() {
    let user = {};
    let id = localStorage.getItem('uid');
    let homepage = this.state.homepage;
    fetch(`${homepage}/getUser?uid=${id}`)
        .then(async response => {
          let results = await response.json();
          console.log(results);
          user = results.result;
        })
        .then(() => {
          this.setState({
            user: user,
            loaded: true,
          })
        })
        .catch(err => {
          console.log(err);
        });
  }

  logout = () => {
    localStorage.removeItem('uid');
    this.setState({
      user: null
    });
    window.location.href= '/';
    console.log('User signed out');
  };

  get = async (url, params) => {
    let finalUrl = this.state.homepage + url;
    if (params) {
      for (let param of params) { 
        if (!params.indexOf(param)) {
          finalUrl += '?';
        }
        finalUrl += param.name;
        finalUrl += '=';
        finalUrl += param.value;
        if (params.indexOf(param) !== params.length - 1) {
          finalUrl += '&';
        }
      }
    }
    return await fetch(finalUrl, {
      method: 'GET',
    })
      .then(async results => {
        if (!results.ok) throw await results.json();
        return await results.json();
      })
      .catch(err => {
        throw(err);
      })
  };

  post = async (url, json) => {
    let finalUrl = this.state.homepage + url;
    return await fetch(finalUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(json)
    })
      .then(async results => {
        if (!results.ok) throw await results.json();
        return await results.json();
      })
      .catch(err => {
        throw(err);
      })
  };

  render() {
    return (
      <div>
        {
          this.state.loaded &&
          <div>
            {
              this.state.user ?
              <div>
                <Router>
                  <Switch>
                    <Route exact path='/'
                           component={props => <SearchPage {...props}
                                                           homepage={this.state.homepage}
                                                           startPage={this.state.startPage}
                                                           get={this.get} 
                                                           post={this.post}
                                                           logout={this.logout}
                                                           user={this.state.user}/>}
                    />
                    <Route exact path={`/exploit/:exploitID`}
                           component={props => <Exploit {...props}
                                                        homepage={this.state.homepage}
                                                        startPage={this.state.startPage}
                                                        get={this.get} 
                                                        post={this.post}
                                                        logout={this.logout}
                                                        user={this.state.user}/>}
                    />
                    <Route exact path={`/newExploit`}
                           component={props => <NewExploit {...props}
                                                           homepage={this.state.homepage}
                                                           startPage={this.state.startPage}
                                                           get={this.get}
                                                           post={this.post}
                                                           logout={this.logout}
                                                           user={this.state.user}/>}
                    />
                    <Route exact path={`/shodan/:shodanIP`}
                           component={props=> <Shodan {...props}
                                                      homepage={this.state.homepage}
                                                      startPage={this.state.startPage}
                                                      get={this.get}
                                                      post={this.post}
                                                      logout={this.logout}
                                                      user={this.state.user}/>}
                    />
                    <Route exact path={`/user/:userID`}
                           component={props=> <Account {...props}
                                                       homepage={this.state.homepage}
                                                       startPage={this.state.startPage}
                                                       get={this.get} 
                                                       post={this.post}
                                                       logout={this.logout}
                                                       user={this.state.user}/>}
                    />
                  </Switch>
                </Router>
              </div> :
              <Router>
                <Switch>
                  <Route exact path='/' component={props => <Login {...props}
                                                                   homepage={this.state.homepage}
                                                                   startPage={this.state.startPage}
                                                                   login={this.login}
                                                                   get={this.get} post={this.post}/>}/>
                  <Route exact path='/createUser'
                         component={props => <CreateUser {...props}
                                                         get={this.get} post={this.post}
                                                         homepage={this.state.homepage}
                                                         startPage={this.state.startPage}/>}/>
                  <Route
                         component={props => <div>This page does not exist. Please go to a different page or log out and try again.
                                             <button onClick={this.logout}>Log out</button>
                         </div>}/>
                </Switch>
              </Router>
            }
          </div>
        }
      </div>
    )
  }
}

export default App;
